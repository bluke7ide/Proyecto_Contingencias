---
title: "Proyecto - Contingencias de Vida I"
author: 
  - Estudiantes
  - Luis Fernando Amey Apuy - C20470
  - Fabián Brenes Thomas - C21380
  - Marco Antonio Guardia Ortiz - C23521
  - Anthony Mauricio Jiménez Navarro - C24067
  - Laura Jimena Villacís Delgado - C28386
date: "2024-05-13"
output: 
  rmdformats::downcute:
    default_style: "dark"
    downcute_theme: "chaos"
---
```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

# Importar y descargar los datos
```{r, warning=FALSE}
library(readxl)
library(readr)
library(tidyverse)
library(ggplot2)
ABC <- read_excel("data/Base de datos.xlsx")
SUPEN <- read_excel("data/tavid2000-2150.xls")
SUPEN_num <- as.data.frame(lapply(SUPEN, as.numeric), stringsAsFactors = FALSE)
```

#Observaciones iniciales
## Transformaciones menores
```{r}
#Agregar columna de edad:
ABC$Edad = 2023 - as.double(format(ABC$`Fecha de nacimiento`, format="%Y")) 
ABC[ABC$Sexo == 'M',]$Sexo <- 'Hombres' #hombres: 1
ABC[ABC$Sexo == 'F',]$Sexo <- 'Mujeres'#Mujeres: 2
```

## Transformaciones y visualizaciones iniciales
```{r}

#Agregar una columna de rango de edad. 
#Rangos:  20-24, 25-29, 30-34, 35-39, 40-44, 45-49, 50-54, 55-59, 60-64, +65
breaks<-c(20,24,29,34,39,44,49,54,59,65)
labels<-c("20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64")
ABC$rango_edad<-cut(ABC$Edad, breaks=breaks, labels=labels, right=FALSE)

# Agrupar los datos por rango de edad y sexo, y calcular la frecuencia
tabla_rangos_sexo <- table(ABC$rango_edad, ABC$Sexo)
tabla_porcentaje_sexo <- prop.table(tabla_rangos_sexo, margin=1) * 100

tabla_rangos_sexo <- data.frame(
  rango_edad = rep(rownames(tabla_rangos_sexo), times=ncol(tabla_rangos_sexo)),
  sexo = rep(colnames(tabla_rangos_sexo), each=nrow(tabla_rangos_sexo)),
  frecuencia = as.vector(tabla_rangos_sexo),
  porcentaje = round(as.vector(tabla_porcentaje_sexo), 2)
)

#Observaciones de distribuciones
ggplot(data=tabla_rangos_sexo, aes(x=rango_edad, y=frecuencia))+
geom_bar(stat="identity", fill="darkseagreen3")+
labs(title="Distribución de rangos de edad", x="Edad", y="Frecuencia")+
theme_minimal()

ggplot(data=tabla_rangos_sexo, aes(x=rango_edad, y=frecuencia, fill=sexo)) +
  geom_bar(stat="identity", position="dodge") +
  labs(title="Distribución de rangos de edad por sexo", x="Edad", y="Frecuencia") +
  scale_fill_manual(name="Sexo", values=c("Hombres"="steelblue3", "Mujeres"="hotpink3"), labels=c("Hombres", "Mujeres"))+
  theme_minimal()
```

## Transformaciones menores finales
```{r}
ABC[ABC$Sexo == 'Hombres',]$Sexo <- "1" 
ABC[ABC$Sexo == 'Mujeres',]$Sexo <- "2"
ABC$Sexo <- as.double(ABC$Sexo) 
```


# Función para recolectar los qx de un df agrupado
```{r}
#' Calcula las probabilidades de vida para todos los años de cada persona
#' @param df_obs caracteristicas de cada persona
#' @param df_prob tabla dinámica de las proabilidades de muerte
#' @return all_qx (una lista que adentro contiene: 1. Una lista con las probabilidades de sobrevivencia para cada persona. 2. El sexo. 3. La edad)
get_qx <- function(df_obs, df_prob){
  c <- 1 #Contador para las personas
  
  #se genera la lista vacía que vamos a devolver
  all_qx = list()
  
  #se itera sobre todas las observaciones del df_obs
  for (i in 1:length(df_obs[[1]])){ #CAMBIO: MAS ENTENDIBLE PONER NROW
    
    #se guarda la edad en x
    x <- df_obs$Edad[i]
    
    #si no es la primera observación
    if(i != 1) {
      
      #si la observación pasada tiene la misma edad y sexo, copia las probabilidades y pasa a la siguiente observación
      if((df_obs$Edad[i-1] == x) & (df_obs$Sexo[i] == df_obs$Sexo[i-1])){
        all_qx[c] <- all_qx[c-1] #copia la lista
        c <- c+1 #Actualizamos el contador de personas
        next #Pasamos a la siguiente iteración
      }
    } 
    
    #se actualiza el año a 2024
    y <- 2024 # modificación puesto estaba en 2023
    
    #Se filtra la base con las probabilidades según el sexo de la observación
    df <- df_prob[df_prob$sex == df_obs$Sexo[i],]
    
    #Inicializamos la sublista de probabilidades.
    local_qx <- list()
   
    #Se hace un while para copiar todas las probabilidades de vida de la observación  en cuestión a partir de la edad y el año actual
     n <- 1 #Contador del while
    while (any(df$edad == x & df$year == y)) {
      # Filtrar datos por edad y año actual para encontrar probabilidad de muerte de la persona a esa edad
      qx <- df[df$edad == x & df$year == y , ]$qx
      
      # Se calcula la probabilidad de sobrevivencia
      local_qx[n] <- 1 - qx
      n <- n + 1
      
      #Se actualiza la edad y el año
      x <- x + 1
      y <- y + 1
    }
    all_qx[[c]] <- list()
    #Se guarda en una lista las probabilidades, el sexo y la edad
    all_qx[[c]][[1]] <- local_qx 
    all_qx[[c]][[2]] <- df_obs$Sexo[i] 
    all_qx[[c]][[3]] <- df_obs$Edad[i] 
    
    c <- c+1 #Actualizamos contador de personas
  }
  
  #Se devuelve la lista con una lista para cada observación
  return(all_qx)
}
```

## Recolectar la probabilidad de muerte/sobrevivencia de cada observación
```{r}
t <- proc.time() #Tiempo de ejecución
qx <- get_qx(ABC, SUPEN_num) #Probabilidades de muerte para personas de ABC
proc.time() - t
```

# Proyecciones demográficas
## Función madre: observar las posibilidades de vivir
```{r}
#Inicializar dataframe, con proyección de vida residual.
proy_per_viva <- data.frame(Año = c(2024:2124), poblacionM = numeric(101),
                            poblacionH = numeric(101)) 
proy_per_viva$poblacionH[1] = 272
proy_per_viva$poblacionM[1] = 228

#' Calcula la proyección demográfica de toda la población evaluada
#' @param qx Lista de listas con las probabilidades de sobrevivencia de cada individuo para cada año
#' @param df df para 3 columnas: edad, poblacionM, poblacionH, con población inicial M de 272 y población inicial H de 228
#' @return df: con la cantidad de personas vivas que se esperan para el año 2024 más i 
proy_viva <- function(qx, df){
  acumH <- numeric(272) + 1 #inicializa vector de tamaño 272 con 1s
  acumM <- numeric(228) + 1 #inicializa vector de tamaño 228 con 1s
  
  #Iterar sobre los años
  for (i in 1:100){
    m <- 0
    h <- 0
    
    #Iterar sobre las personas 
    for (c in 1:500){
      
      #Si es hombre 
      if(qx[[c]][[2]] == 1){
        h <- h + 1 #sumamos un hombre
        
        #Si la persona ya no tiene probabilidades de sobrevivencia, entonces pasamos a la siguiente persona
        if(i > length(qx[[c]][[1]])){
          next
        } 
        
      #guarda el ipx para el hombre h
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
      } 
      
      else { #Es mujer
        m <- m +1 #Añadimos una mujer
        if(i > length(qx[[c]][[1]])){
          next
        }
        #guarda el ipx para la mujer m
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
      }
    }
    #Se lo que se espera que cada persona viva individualmente, para obtener      la cantidad esperada de personas que vivan hasta el año i 
    df$poblacionH[i+1] <- sum(acumH)
    df$poblacionM[i+1] <- sum(acumM)
    
  }
  return(df)
}

#Se utiliza la función que calcula la proyección de personas para cada año
proy_per_viva <- proy_viva(qx, proy_per_viva)
#Se redondean las proyecciones a 8 decimales
proy_per_viva$poblacionM <- round(proy_per_viva$poblacionM, 8)
proy_per_viva$poblacionH <- round(proy_per_viva$poblacionH, 8)
```

## Caso contrario
```{r}
#Se calcula la cantidad de personas muertas de la siguiente manera, ya que es el complemento de las personas vivas 
proy_per_muerta <- proy_per_viva
proy_per_muerta$poblacionM <- 228 - proy_per_muerta$poblacionM
proy_per_muerta$poblacionH <- 272 - proy_per_muerta$poblacionH
```

## Seccionar a solo empleados vivos
```{r}
proy_emp_viva <- data.frame(Año = c(2024:2124), poblacionM = numeric(101), poblacionH = numeric(101))
proy_emp_viva$poblacionH[1] = 272
proy_emp_viva$poblacionM[1] = 228

#' 
#' @param qx Lista de listas con las probabilidades de sobrevivencia de cada individuo para cada año
#' @param df df para 3 columnas: edad, poblacionM, poblacionH, con población inicial M de 272 y población inicial H de 228
#' @return df: Proyección demográfica de empleados activos
proy_emp_vivos <- function(qx, df){
  
  acumH <- numeric(272) + 1 #inicializa vector de tamaño 272 con 1s
  acumM <- numeric(228) + 1 #incializa vector de tamaño 228 con 1s
  
  #iteramos sobre los años
  for (i in 1:100){
    m <- 0 #contador de mujeres
    h <- 0 #contador de hombres
    
    #Iterar sobre las personas
    for (c in 1:500){
      
     #Si es hombre
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        
         #Si la persona ya no tiene probabilidades de sobrevivencia, entonces pasamos a la siguiente persona
        if(i > length(qx[[c]][[1]])){
          next
        }
        
        #Si la persona tiene más de 65 (edad +año) pasamos a la siguiente
        if(65 < qx[[c]][[3]] + i){
          acumH[h] <- 0
          next
        } 
        
        #guarda el ipx para el hombre h
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
      } 
      
      #Si es mujer
      else {
        m <- m +1
        
        #Si la persona ya no tiene probabilidades de sobrevivencia, entonces pasamos a la siguiente persona
        if(i > length(qx[[c]][[1]])){
          next
        
        }   
        
        #Si la persona tiene más de 65 (edad +año) pasamos a la siguiente
        if(65 < qx[[c]][[3]] + i){
          acumM[m] <- 0
          next
        } 
        
         #guarda el ipx para la mujer m
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
      }
    }
     # Se obtiene la cantidad esperada de personas que vivan hasta el año i         sumando lo que se espera que cada persona viva individualmente
    df$poblacionH[i+1] <- sum(acumH)
    df$poblacionM[i+1] <- sum(acumM)
  }
  return(df)
}

#Se utiliza la función que calcula la proyección de personas para cada año
proy_emp_viva <- proy_emp_vivos(qx, proy_emp_viva)
#Se redondean las proyecciones a 8 decimales
proy_emp_viva$poblacionM <- round(proy_emp_viva$poblacionM, 8)
proy_emp_viva$poblacionH <- round(proy_emp_viva$poblacionH, 8)
```

## Seccionar a solo pensionados vivos
```{r}
#Se crea el data frame para las proyecciones de las personas pensionadas
proy_pen_viva <- data.frame(Año = c(2024:2124), poblacionM = numeric(101), poblacionH = numeric(101))

#'Calcula para proyección demográfica de los pensionados
#' @param qx Lista de listas con las probabilidades de sobrevivencia de cada individuo para cada año
#' @param df df para 3 columnas: edad, poblacionM, poblacionH, con población inicial M de 272 y población inicial H de 228
#' @return df: Proyección demográfica de empleados pensionados
proy_pen_vivos <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  
  #Se itera sobre los años
  for (i in 1:100){
    
    m <- 0
    h <- 0
    
    #Se genera un vector para llevar cuenta de las personas pensionadas
    penH <- numeric(272)
    penM <- numeric(228)
    
    #Se itera sobre todas las personas
    for (c in 1:500){
      
      #Si es hombre
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        
        #Si la persona ya no tiene probabilidades de vivir
        if(i > length(qx[[c]][[1]])){
          next
        }
        
        #Si la persona tiene más de 65 años entonces se pone un uno en el            vector para llevar la cuenta de los pensionados
        if(65 < qx[[c]][[3]] + i){
          penH[h] <- 1
        }
        
        #Se van guardando las probabilidades de vida en penH solo para los            pensionados
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
        penH[h] <- penH[h] * acumH[h]
      } 
      #Si es mujer
      else { 
        m <- m +1
        
        #Si la persona ya no tiene probabilidades de vivir
        if(i > length(qx[[c]][[1]])){
          next
        }    
        
        #Si la persona tiene más de 65 años entonces se pone un uno en el            vector para llevar la cuenta de los pensionados
        if(65 < qx[[c]][[3]] + i){
          penM[m] <- 1
        } 
        
        #Se van guardando las probabilidades de vida en penM solo para los          pensionados
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
        penM[m] <- penM[m]*acumM[m]
      }
    }
    
    # Se obtiene la cantidad esperada de personas que vivan hasta el año i      sumando lo que se espera que cada persona viva individualmente
    df$poblacionH[i+1] <- sum(penH)
    df$poblacionM[i+1] <- sum(penM)
  }
  return(df)
}

#Se utiliza la función que calcula la proyección de personas para cada año
proy_pen_viva <- proy_pen_vivos(qx, proy_pen_viva)
#Se redondean las probabilidades a 8 decimales
proy_pen_viva$poblacionM <- round(proy_pen_viva$poblacionM, 8)
proy_pen_viva$poblacionH <- round(proy_pen_viva$poblacionH, 8)
```

## Seccionar a solo empleados muertos
```{r}

#Crea un data frame para guardar la proyección demográfica de las muertes de los empleados 
proy_emp_muerta <- data.frame(Año = c(2024:2124), poblacionM = numeric(101), poblacionH = numeric(101))

#'Calcula para proyección demográfica de las muertes de empleados activos
#' @param qx Lista de listas con las probabilidades de sobrevivencia de cada individuo para cada año
#' @param df df para 3 columnas: edad, poblacionM, poblacionH, con población inicial M de 272 y población inicial H de 228
#' @return df: Proyección demográfica de las muertes de los empleados activos
proy_emp_dead <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  
  #Se itera sobre los años
  for (i in 1:100){
    m <- 0
    h <- 0
    
    #Se crean vectores con 0s para guardar las probabilidades de muerte  personas activas
    localH <- numeric(272)
    localM <- numeric(228)
    
    #Se itera sobre cada persona
    for (c in 1:500){
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        if(i > length(qx[[c]][[1]])){
          next
        }
        #Si la persona ya es mayor a 65, se cuenta como pensionada y no se            guardan sus proabilidades de muerte
        if(65 < qx[[c]][[3]] + i){
          acumH[h] <- 0
          next
        }
        
        #Se guardan las probabilidades de muerte para las personas activas
        localH[h] <- acumH[h]*(1 - qx[[c]][[1]][[i]])
        
        #Se actualizan las probabilidades de sobrevivencia 
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
        
      } else { #Si es mujer
        m <- m +1
        if(i > length(qx[[c]][[1]])){
          next
        }     
        if(65 < qx[[c]][[3]] + i){
          acumM[m] <- 0
          next
        }
        localM[m] <- acumM[m]*(1 - qx[[c]][[1]][[i]])
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
        
      }
    }
    #Se calcula la esperanza de muertes en el año i y se le suma las muertes del año anterior. 
    df$poblacionH[i+1] <- sum(localH) + df$poblacionH[i]
    df$poblacionM[i+1] <- sum(localM) + df$poblacionM[i]
  }
  return(df)
}

#Aplicamos la función
proy_emp_muerta <- proy_emp_dead(qx, proy_emp_muerta)
proy_emp_muerta$poblacionM <- round(proy_emp_muerta$poblacionM, 8)
proy_emp_muerta$poblacionH <- round(proy_emp_muerta$poblacionH, 8)
```

## Seccionar a solo pensionados muertos
```{r}
#Crea un data frame para guardar la proyección demográfica de las muertes de los pensionados 

 
proy_pen_muerta <- data.frame(Año = c(2024:2124), poblacionM = numeric(101), poblacionH = numeric(101))

#'Calcula para proyección demográfica de las muertes de pensionados
#' @param qx Lista de listas con las probabilidades de sobrevivencia de cada individuo para cada año
#' @param df df para 3 columnas: edad, poblacionM, poblacionH, con población inicial M de 272 y población inicial H de 228
#' @return df: Proyección demográfica de las muertes de los pensionados
proy_pen_dead <- function(qx, df){
  
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  
  #Se itera sobre los años
  for (i in 1:100){
    m <- 0
    h <- 0
    
    #inicializamos vectores en 0s para guardar probabilidades de muerte para los pensionados
    penH <- numeric(272)
    penM <- numeric(228)
    
    for (c in 1:500){
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        
        if(i > length(qx[[c]][[1]])){
          next
        }
        
         
        #Si la persona tiene más de 65 años entonces se pone un uno en el            vector para llevar la cuenta de los pensionados
        if(65 < qx[[c]][[3]] + i){
          penH[h] <- 1 
        }
        
        #Se van guardando las probabilidades de muerte en penH solo para los  pensionados
        penH[h] <- penH[h] * acumH[h] *(1 - qx[[c]][[1]][[i]])
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
      } else { #si es mujer 
        m <- m +1
        
        if(i > length(qx[[c]][[1]])){
          next
        }     
        if(65 < qx[[c]][[3]] + i){
          penM[m] <- 1
        } 
        #Se van guardando las probabilidades de vida en penM solo para los          pensionados
        penM[m] <- penM[m]*acumM[m]*(1-qx[[c]][[1]][[i]])
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
      }
    }
    
    #Se calcula la esperanza de muertes en el año i y se le suma las muertes     del año anterior. 
    df$poblacionH[i+1] <- sum(penH) + df$poblacionH[i]
    df$poblacionM[i+1] <- sum(penM) + df$poblacionM[i]
  }
  return(df)
}
proy_pen_muerta <- proy_pen_dead(qx, proy_pen_muerta)
proy_pen_muerta$poblacionM <- round(proy_pen_muerta$poblacionM, 8)
proy_pen_muerta$poblacionH <- round(proy_pen_muerta$poblacionH, 8)
```

# Resumir los resultados demográficos
## En la proyección de mujeres
```{r}
#Un df con todas las proyecciones de las mujeres
proy_mujeres <- data.frame(
  año = 2024:2124,
  proy_vivas = proy_per_viva$poblacionM,
  proy_muertas = proy_per_muerta$poblacionM,
  proy_emp_vivas = proy_emp_viva$poblacionM,
  proy_pen_vivas = proy_pen_viva$poblacionM,
  proy_emp_muertas = proy_emp_muerta$poblacionM,
  proy_pen_muertas = proy_pen_muerta$poblacionM
)
```

### Observación de la data
```{r, echo=FALSE, warning=FALSE}
ggplot() +
  geom_line(data = proy_mujeres,
            aes(x = año, y = proy_emp_vivas, color = "emp_vivas"),
            size = 1) +
  geom_line(data = proy_mujeres,
            aes(x = año, y = proy_pen_vivas, color = "pen_vivas"),
            size = 1) +
  geom_line(
    data = proy_mujeres,
    aes(x = año, y = proy_emp_muertas, color = "emp_muertas"),
    size = 1
  ) +
  geom_line(
    data = proy_mujeres,
    aes(x = año, y = proy_pen_muertas, color = "pen_muertas"),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "emp_vivas" = "deeppink1",
      "pen_vivas" = "darksalmon",
      "emp_muertas" = "darkred",
      "pen_muertas" = "goldenrod4"
    )
  ) +
  labs(
    x = "Año",
    y = "Personas",
    title = "Proyección Demográfica para las mujeres",
    color = "Tipo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom')
```

## En la proyección de hombres
```{r}
#Un df con todas las proyecciones de los hombres
proy_hombres <- data.frame(
  año = 2024:2124,
  proy_vivos = proy_per_viva$poblacionH,
  proy_muertos = proy_per_muerta$poblacionH,
  proy_emp_vivos = proy_emp_viva$poblacionH,
  proy_pen_vivos = proy_pen_viva$poblacionH,
  proy_emp_muertos = proy_emp_muerta$poblacionH,
  proy_pen_muertos = proy_pen_muerta$poblacionH
)
```

### Observación de la data
```{r, echo=FALSE, warning=FALSE}
ggplot() +
  geom_line(data = proy_hombres,
            aes(x = año, y = proy_emp_vivos, color = "emp_vivos"),
            size = 1) +
  geom_line(data = proy_hombres,
            aes(x = año, y = proy_pen_vivos, color = "pen_vivos"),
            size = 1) +
  geom_line(
    data = proy_hombres,
    aes(x = año, y = proy_emp_muertos, color = "emp_muertos"),
    size = 1
  ) +
  geom_line(
    data = proy_hombres,
    aes(x = año, y = proy_pen_muertos, color = "pen_muertos"),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "emp_vivos" = "mediumturquoise",
      "pen_vivos" = "deepskyblue4",
      "emp_muertos" = "navy",
      "pen_muertos" = "gray11"
    )
  ) +
  labs(
    x = "Año",
    y = "Personas",
    title = "Proyección Demográfica para los hombres",
    color = "Tipo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom')
```

## Observación de la data general
```{r, echo=FALSE, warning=FALSE}
ggplot() +
  geom_line(data = proy_hombres,
            aes(x = año, y = proy_vivos, color = "vivos"),
            size = 1) +
  geom_line(data = proy_hombres,
            aes(x = año, y = proy_muertos, color = "muertos"),
            size = 1) +
  geom_line(
    data = proy_mujeres,
    aes(x = año, y = proy_vivas, color = "vivas"),
    size = 1
  ) +
  geom_line(
    data = proy_mujeres,
    aes(x = año, y = proy_muertas, color = "muertas"),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "vivos" = "dodgerblue1",
      "muertos" = "darkblue",
      "vivas" = "magenta2",
      "muertas" = "red3"
    )
  ) +
  labs(
    x = "Año",
    y = "Personas",
    title = "Proyección Demográfica general",
    color = "Tipo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom')
```

## Gráficos para el resporte actuarial
```{r}
ggplot() +
  geom_line(data = proy_mujeres,
            aes(x = año, y = proy_emp_vivas, color = "vivos"),
            size = 1) +
  labs(
    x = "Año",
    y = "Cantidad de personas",
    title = "Proyección demográfica de empleados activos mujeres"
  ) +
  scale_color_manual(
    values = c('vivos'='hotpink3')) +
  theme_minimal() +
  theme(legend.position = 'none') +
  scale_y_continuous(breaks = seq(0, 228, by = 50)) 

```


```{r}
ggplot() +
  geom_line(data = proy_hombres,
            aes(x = año, y = proy_emp_vivos, color = "vivos"),
            size = 1) +
  labs(
    x = "Año",
    y = "Cantidad de personas",
    title = "Proyección demográfica de empleados activos hombres"
  ) +
  scale_color_manual(
    values = c('vivos'='steelblue3')) +
  theme_minimal() +
  theme(legend.position = 'none') +
  scale_y_continuous(breaks = seq(0, 272, by = 50)) 

```
```{r}
ggplot() +
  geom_line(data = proy_mujeres,
            aes(x = año, y = proy_pen_vivas, color = "vivos"),
            size = 1) +
  labs(
    x = "Año",
    y = "Cantidad de personas",
    title = "Proyección demográfica de pensionados mujeres"
  ) +
  scale_color_manual(
    values = c('vivos'='hotpink3')) +
  theme_minimal() +
  theme(legend.position = 'none') +
  scale_y_continuous(breaks = seq(0, 228, by = 50)) 

```


```{r}
ggplot() +
  geom_line(data = proy_hombres,
            aes(x = año, y = proy_pen_vivos, color = "vivos"),
            size = 1) +
  labs(
    x = "Año",
    y = "Cantidad de personas",
    title = "Proyección demográfica de pensionados hombres"
  ) +
  scale_color_manual(
    values = c('vivos'='steelblue3')) +
  theme_minimal() +
  theme(legend.position = 'none') +
  scale_y_continuous(breaks = seq(0, 272, by = 50)) 
```

```{r}
ggplot() +
  geom_line(
    data = proy_mujeres,
    aes(x = año, y = proy_emp_muertas, color = "emp_muertas"),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "emp_muertas" = "hotpink3"
    )
  ) +
  labs(
    x = "Año",
    y = "Personas",
    title = "Proyección demográfica de muertes de mujeres empleadas",
    color = "Tipo"
  ) +
  theme_minimal() +
  theme(legend.position = 'none')
```

```{r}
ggplot() +
  geom_line(
    data = proy_hombres,
    aes(x = año, y = proy_emp_muertos, color = "emp_muertos"),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "emp_muertos" = "steelblue3"
    )
  ) +
  labs(
    x = "Año",
    y = "Personas",
    title = "Proyección demográfica de muertes de hombres empleados",
    color = "Tipo"
  ) +
  theme_minimal() +
  theme(legend.position = 'none')
```


```{r}
ggplot() +
  geom_line(
    data = proy_mujeres,
    aes(x = año, y = proy_pen_muertas, color = "pen_muertas"),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "pen_muertas" = "hotpink3"
    )
  ) +
  labs(
    x = "Año",
    y = "Personas",
    title = "Proyección demográfica de muertes de mujeres pensionadas",
    color = "Tipo"
  ) +
  theme_minimal() +
  theme(legend.position = 'none')
```


```{r}
ggplot() +
  geom_line(
    data = proy_hombres,
    aes(x = año, y = proy_pen_muertos, color = "pen_muertos"),
    size = 1
  ) +
  scale_color_manual(
    values = c(
      "pen_muertos" = "steelblue3"
    )
  ) +
  labs(
    x = "Año",
    y = "Personas",
    title = "Proyección demográfica de muertes de hombres pensionados",
    color = "Tipo"
  ) +
  theme_minimal() +
  theme(legend.position = 'none')
```



## Verificar los resultados
```{r}
# suma_hombres <- proy_hombres$proy_emp_vivos +
#   proy_hombres$proy_pen_vivos +
#   proy_hombres$proy_emp_muertos +
#   proy_hombres$proy_pen_muertos
# 
# suma_mujeres <- proy_mujeres$proy_emp_vivas +
#   proy_mujeres$proy_pen_vivas +
#   proy_mujeres$proy_emp_muertas +
#   proy_mujeres$proy_pen_muertas

```

```{r}
rm(proy_emp_muerta)
rm(proy_per_viva)
rm(proy_per_muerta)
rm(proy_emp_viva)
rm(proy_pen_viva)
rm(proy_pen_muerta)
rm(t)
rm(proy_emp_dead)
rm(proy_viva)
rm(proy_pen_vivos)
rm(proy_pen_dead)
rm(proy_emp_vivos)
```

# Proyección financiera
## Proyección del VP de los pagos de beneficio de muerte de empleados activos
```{r}
#' Calcula el valor presente de las obligaciones de cada año por muerte de los empleados activos. 
#' @param df Recibe el df de proy_hombres o proy_mujeres
#' @return Devuelve un vector con el valor presente para cada año
proy_emp_vp <- function(df){
  #La columna 6 es la de la proyección demógrafica de las muertes de los      empleados activos
  col <- df[[6]] 
  
  #Fórmula=cantidad de muerte*suma asegurada*v^cantidad de años desde 2024
  for (i in 1:100){
    col[102-i] <- (col[102-i]-
                     col[101-i])*5000000*((1.03^(100-i))/(1.07)^(99-i))
    # se hace el supuesto que empieza a inflarse el monto después del primer pago
    #Modificación: 100-i pasó a ser 100-i+1 para contemplar de que se paga al final del año.
  }
  return(col)
}
```

### Observaciones
```{r}
proy_H_fin <- data.frame(edad = 0:100)
proy_M_fin <- data.frame(edad = 0:100)
proy_H_fin$proy_emp_vp <- round(proy_emp_vp(proy_hombres),2)
proy_M_fin$proy_emp_vp <- round(proy_emp_vp(proy_mujeres),2)
```

## Proyección financiera de los pagos de beneficio de muerte de empleados activos
```{r}
#' Calcula el valor financiero de las obligaciones de cada año por muerte de los empleados activos. Este no se descuenta al 2024, sino que sería el valor financiero de ese mismo año. 
#' @param df Recibe el df de proy_hombres o proy_mujeres
#' @return Devuelve un vector con el valor de las obligaciones de ese año
proy_emp_fin <- function(df){
  #La columna 6 es la de la proyección demógrafica de las muertes de los      empleados activos
  col <- df[[6]]
  for (i in 1:100){
    #Fórmula=cantidad de muerte*suma asegurada
    col[102-i] <- (col[102-i] - col[101-i])*5000000*(1.03)^(100-i)
    # se hace el supuesto que empieza a inflarse el monto después del primer pago
  }
  return(col)
}
```

### Observaciones
```{r}
proy_H_fin$proy_emp_fin <- round(proy_emp_fin(proy_hombres),2)
proy_M_fin$proy_emp_fin <- round(proy_emp_fin(proy_mujeres),2)
```

## Proyección del VP de los pagos de beneficio de muerte de pensionado
```{r}
#' Calcula el valor presente de las obligaciones de cada año por muerte de los pensionados. 
#' @param df Recibe el df de proy_hombres o proy_mujeres
#' @return Devuelve un vector con el valor presente para cada año
proy_pen_vp <- function(df){
  col <- df[[7]] #la columna 7 es la proyección de pensionados muertos
  for (i in 1:100){
    #Fórmula=cantidad de muerte*suma asegurada*v^cantidad de años desde 2024
    col[102-i] <- (col[102-i]
                   -col[101-i])*1000000*((1.03^(100-i))/(1.07)^(99-i))
    #se hace el supuesto que empieza a inflarse el monto después del primer pago
    #Modificación: 100-i pasó a ser 100-i+1 para contemplar de que se paga al final del año.
  }
  return(col)
}
```

### Observaciones
```{r}
proy_H_fin$proy_pen_vp <- round(proy_pen_vp(proy_hombres),2)
proy_M_fin$proy_pen_vp <- round(proy_pen_vp(proy_mujeres),2)
```

## Proyección financiera de los pagos de beneficio de muerte de pensionado
```{r}
#' Calcula el valor financiero de ese año de las obligaciones de cada año por muerte de los pensionados. 
#' @param df Recibe el df de proy_hombres o proy_mujeres
#' @return Devuelve un vector con el valor presente para cada año
proy_pen_fin <- function(df){
  col <- df[[7]]
  for (i in 1:100){
    #Fórmula=cantidad de muerte*suma asegurada
    col[102-i] <- (col[102-i] - col[101-i])*1000000*(1.03)^(100-i)
    # se hace el supuesto que empieza a inflarse el monto después del primer pago
  }
  return(col)
}
```

### Observaciones
```{r}
#' Calcula el valor presente de ese año de las obligaciones por las anualidades de los pensionados
#' @param df Recibe el df de proy_hombres o proy_mujeres
#' @return Devuelve un vector con el valor presente para cada año 
proy_ann_vp <- function(df){
  #La columna 5 es la proyección demográfica de pensionados vivos
  col <- df[[5]]
  pen_muertos<-df[[7]]
  
  #Se calcula la tasa mensual efectiva
  interes <- 1.07^(1/12) - 1
  
  # se hace el supuesto que paga la primera pensión al final de mes
  #fórmula: Monto*a:12 (con tasa mensual)
  VP_ann <- 300000*(1-(1/1.07))/interes
  
  #fórmula: Monto/tasa anual
  VP_agui <- 300000*(1/1.07) # modificación - aguinaldo a final de año
  VP <- VP_ann + VP_agui
  
  #iteramos sobre los años para asignar el valor presente de cada año
  #Se calcula cuántos pensionados se mueren ese año, y se utiliza el supuesto de distribución uniforme
  for (i in 1:100){
    valor_pres<-0
    
    #Calculamos los pensionados que sobreviven todo ese año:
    #Calculamos los pensionados muertos al mes
    if(i==1){
      pensionados_vivos<-col[i]
      pensionados_muertos_xmes<-pen_muertos[i]
    } else{
       pensionados_vivos<-col[i]-(pen_muertos[i]-pen_muertos[i-1])
        pensionados_muertos_xmes<-(pen_muertos[i]-pen_muertos[i-1])/12
       
    }
    
    #A estos pensionados muertos, se les pagará la pensión solo por una parte del año:
    for (m in 1:11){
      valor_pres<-valor_pres+
        pensionados_muertos_xmes*300000*
        (1/(1+interes)^m)*((1.03/1.07)^(i-1))
      
    }
    #A los que no se mueren en ese año, se les paga todo el año más el aguinaldo
    valor_pres<-valor_pres+pensionados_vivos*VP*(1.03/1.07)^(i-1)
    col[i] <- valor_pres
    valor_pres<-0
  }
  # se hace el supuesto que empieza a inflarse el monto después del primer pago, además se trae a valor presente a partir del segundo año (el primer año ya se trae a valor presente mediante el uso de la anualidad a:12)
  return(col)
}
```

### Observaciones
```{r}
proy_H_fin$proy_ann_vp <- round(proy_ann_vp(proy_hombres),2)
proy_M_fin$proy_ann_vp <- round(proy_ann_vp(proy_mujeres),2)
```

## Proyección de los pagos de beneficio de anualidades
```{r}
#' Calcula el valor financiero de ese año de las obligaciones por las anualidades de los pensionados
#' @param df Recibe el df de proy_hombres o proy_mujeres
#' @return Devuelve un vector con el valor financiero para cada año 
proy_ann_fin <- function(df){
  col <- df[[5]]
  for (i in 1:100){
    #13*300 000= 3 900 000
    col[i+1] <- col[i+1]*3900000*(1.03)^(i-1)
  }
  # se hace el supuesto que empieza a inflarse el monto después del primer pago
  return(col)
}
```

### Observaciones
```{r}
proy_H_fin$proy_ann_fin <- round(proy_ann_fin(proy_hombres),0)
proy_M_fin$proy_ann_fin <- round(proy_ann_fin(proy_mujeres),0)
```

# Resumir los resultados financieros
## Sumar los resultados
```{r}
#sumamos todas las obligaciones y lo guardamos en proy_hombres y proy_mujeres
proy_hombres$valor_fin <- proy_H_fin$proy_emp_fin + proy_H_fin$proy_pen_fin + proy_H_fin$proy_ann_fin
proy_hombres$valor_p <- proy_H_fin$proy_emp_vp + proy_H_fin$proy_pen_vp + proy_H_fin$proy_ann_vp
proy_mujeres$valor_fin <- proy_M_fin$proy_emp_fin + proy_M_fin$proy_pen_fin + proy_M_fin$proy_ann_fin
proy_mujeres$valor_p <- proy_M_fin$proy_emp_vp + proy_M_fin$proy_pen_vp + proy_M_fin$proy_ann_vp
```

## Graficar
```{r}
ggplot() +
  geom_line(data = proy_hombres,
            aes(x = año, y = valor_fin/1000000, color = "hombres"),
            size = 1) +
  geom_line(data = proy_mujeres,
            aes(x = año, y = valor_fin/1000000, color = "mujeres"),
            size = 1) +
  scale_color_manual(
    values = c(
      "hombres" = "royalblue",
      "mujeres" = "purple"
    )
  ) +
  labs(
    x = "Año",
    y = "Monto (millones)",
    title = "Proyección financiera por edad y sexo, en millones",
    color = "Sexo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom')
```
Este comportamiento se da porque primero los hombres se mueren más temprano, entonces esos 5 millones evalúan más la remuneración. Pasado ese punto, aproximadamente 45 años, entonces ya no existe esa remuneración, por la cual la pensión tomará peso y por lo tanto costará más pagarle a las mujeres. 


```{r}
rm(proy_ann_fin)
rm(proy_ann_vp)
rm(proy_emp_fin)
rm(proy_emp_vp)
rm(proy_pen_fin)
rm(proy_pen_vp)
rm(proy_H_fin)
rm(proy_M_fin)

```


# Prima anual
## Función de la prima
Va a servir para la nivelada
```{r}
#' Calcula la prima anual para los empleados de ABC
#' @param df Recibe el df de probabilidades de sobrevivencia de las personas de ABC
#' @return Devuelve un data frame con edad, sexo, la prima anual y el vp de las obligaciones de la empresa con la persona. 
primas <- function(qx){
  c <- 1
  df = data.frame(edad = numeric(500), sexo = numeric(500), prima = numeric(500))
  
  #Se itera sobre las personas
  for (i in 1:500){
    x <- qx[[i]] 
    
    
    if(i != 1) {  
      
      ant <-qx[[i-1]]
      if((x[[2]] == ant[[2]]) & (x[[3]] == ant[[3]])){
        df[c,] <-df[c-1,]
        c <- c+1
        next
      }
    } 
    vp_pen <- 0
    vp_ann<-0
    px_acum <- 1
    ann_primas<-0
    
    #Iteramos sobre la cantidad de años posibles de la persona x
    for (j in 1:length(x[[1]])) {
      #vp_pen <- vp_pen 
      # 3 cosas:
      # 1) cálculo de los 1M en caso de muerte del pensionado
      # 2) cálculo de los 5M en caso de muerte del empleado
      # 3) cálculo de la pensión
      # 4) cálculo de la anualidad para las primas
     
      #Si la persona tiene menos de 65 calculamos el seguro de empleado activo y la prima 
      if (j + x[[3]] <= 65){
         ann_primas<-ann_primas+
           px_acum*x[[1]][[j]]*(1.03^(j-1))/(1.07^j) 
        
        #Calculamos el vp del seguro de empleado activo
        vp_pen <- vp_pen + px_acum *(1-x[[1]][[j]])*
          5000000*(1.03^(j-1))/(1.07^j) 
      } else { 
        #Si tiene mas de 65 le calculamos la pensión y el seguro de muerte de pensionado
        interes <- 1.07^(1/12)-1 #tasa efectiva mensual
        
        #utilizaremos el supuesto de distribución uniforme de muertes
        for (m in 1:12){
          #Se calcula la probabilidad de vivir j+periodo fraccional de m meses
          prob_frac<-(1-(m/12))*px_acum+(m/12)*px_acum*x[[1]][[j]]
         
          #se hace el supuesto que paga la primera pensión al final de mes 
          #nos traemos el pago mensual de la pensión a valor actuarial
          vp_pen<-vp_pen+
            300000*prob_frac*(1/(1+interes)^m)*(1.03/1.07)^(j-1)
          
          vp_ann<-vp_ann+300000*prob_frac*(1/(1+interes)^m)*(1.03/1.07)^(j-1)
          
          #Si sobrevive al último mes se le paga también el aguinaldo
          if(m==12){
            vp_pen <-vp_pen+
          300000*px_acum*(x[[1]][[j]])*(1/1.07)*(1.03/1.07)^(j-1)
            
            vp_ann <-vp_ann+
          300000*px_acum*(x[[1]][[j]])*(1/1.07)*(1.03/1.07)^(j-1)
          }
        }
        
        #Calculamos el vp del seguro del pensionado
        vp_pen <- vp_pen + 
          px_acum *(1 - x[[1]][[j]])*1000000*(1.03^(j-1))/(1.07^j) 
      }
      px_acum <- px_acum *(x[[1]][[j]])
    }
    
    df$edad[c] <- x[[3]]
    df$sexo[c] <- x[[2]]
    df$vp[c] <- vp_pen
    df$anualidad[c] <- ann_primas
    df$prima[c] <- vp_pen/ann_primas
    df$vp_ann[c]<-vp_ann
    c <- c+1
  }
  return(df)
}
primas_anuales <- primas(qx)
primas_anuales <- primas_anuales %>% arrange(edad) %>% distinct()
```

## Resumir la prima anual
```{r}
ggplot() +
  geom_line(data = primas_anuales[primas_anuales$sexo == 1,],
            aes(x = edad, y = prima/1000000, color = "hombres"),
            size = 1) +
  geom_line(data = primas_anuales[primas_anuales$sexo == 2,],
            aes(x = edad, y = prima/1000000, color = "mujeres"),
            size = 1) +
  scale_color_manual(
    values = c(
      "hombres" = "royalblue",
      "mujeres" = "purple"
    )
  ) +
  labs(
    x = "Año",
    y = "Monto (millones)",
    title = "Primas anuales por edad y sexo, en millones",
    color = "Sexo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom')
```

```{r}
ggplot() +
  geom_line(data = primas_anuales[primas_anuales$sexo == 1,],
            aes(x = edad, y = prima/1000000, color = "hombres"),
            size = 1) +
  geom_line(data = primas_anuales[primas_anuales$sexo == 2,],
            aes(x = edad, y = prima/1000000, color = "mujeres"),
            size = 1) +
  scale_color_manual(
    values = c(
      "hombres" = "royalblue",
      "mujeres" = "purple"
    )
  ) +
  labs(
    x = "Año",
    y = "Monto (millones)",
    title = "Primas anuales por sexo, de 20 a 50 años, en millones",
    color = "Sexo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(20,50) +
  ylim(0, 3)
```

```{r}
ggplot() +
  geom_line(data = primas_anuales[primas_anuales$sexo == 1,],
            aes(x = edad, y = prima/1000000, color = "hombres"),
            size = 1) +
  geom_line(data = primas_anuales[primas_anuales$sexo == 2,],
            aes(x = edad, y = prima/1000000, color = "mujeres"),
            size = 1) +
  scale_color_manual(
    values = c(
      "hombres" = "royalblue",
      "mujeres" = "purple"
    )
  ) +
  labs(
    x = "Año",
    y = "Monto (millones)",
    title = "Primas anuales por sexo, de 50 a 64 años, en millones",
    color = "Sexo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(50,64) +
  ylim(0, 60)
```

```{r}
ggplot() +
  geom_line(data = log(primas_anuales[primas_anuales$sexo == 1,]),
            aes(x = edad, y = prima, color = "hombres"),
            size = 1) +
  geom_line(data = log(primas_anuales[primas_anuales$sexo == 2,]),
            aes(x = edad, y = prima, color = "mujeres"),
            size = 1) +
  scale_color_manual(
    values = c(
      "hombres" = "royalblue",
      "mujeres" = "purple"
    )
  ) +
  labs(
    x = "Año",
    y = "Monto(log)",
    title = "Primas anuales por edad y sexo, en logaritmo",
    color = "Sexo"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') 
```

# Prima nivelada
## Suma de los valores presentes
```{r}
#Sumamos toda las obligaciones de la empresa en su valor presente
(suma_vp <- sum(proy_hombres$valor_p) + sum(proy_mujeres$valor_p) )
(suma_check <- sum(primas(qx)$vp))
(resta<-suma_vp-suma_check)

(suma_vp_ann <- sum(proy_H_fin$proy_ann_vp) + sum(proy_M_fin$proy_ann_vp) )
(suma_check_ann<-sum(primas(qx)$vp_ann))
(resta2<-suma_vp_ann-suma_check_ann)
```

## Cálculo de la prima
```{r}
(prima_nivelada <- suma_vp/sum(primas(qx)$anualidad))
```

La prima nivelada entonces da 1.2 millones de colones anuales aproximadamente, o 98 mil colones al mes.

# Prueba de métodos diferentes
## Modificación de la función primas
```{r}
#' Calcula el valor financiero del año de las obligaciones por anualidades de los pensionados
#'
#' @param qx Recibe el dataframe que contiene la probabilidad de supervivencia, edad y sexo para cada individuo
#' @param m_p Monto de la pensión mensual
#' @param m_me Monto en caso de muerte antes de los 65 años
#' @param m_mp Monto en caso de muerte después de los 65 años
#' @return Devuelve un dataframe con la edad, sexo, valor presente, anualidad y prima para cada individuo
primas_esp <- function(qx, m_p, m_me, m_mp){
  # Inicializa el contador y el dataframe de resultados
  c <- 1
  df = data.frame(edad = numeric(500), sexo = numeric(500), prima = numeric(500))
  # Itera sobre cada elemento en la lista qx
  for (i in 1:500){
    x <- qx[[i]]
    # Verifica si el elemento actual es igual al anterior
    if(i != 1) {
      ant <-qx[[i-1]]
      if((x[[2]] == ant[[2]]) & (x[[3]] == ant[[3]])){
        # Si es igual, copia los valores del anterior y pasa al siguiente
        df[c,] <-df[c-1,]
        c <- c+1
        next
      }
    } 
    # Inicializa el valor presente de las pensiones y la probabilidad acumulada
    vp_pen <- 0
    px_acum <- 1
    # Itera sobre cada año para calcular el valor presente de las pensiones
    for (j in 1:length(x[[1]])) {
      vp_pen <- vp_pen 
      # Cálculo del valor presente de las pensiones en caso de muerte antes y después de los 65
      if (j + x[[3]] <= 65){
        vp_pen <- vp_pen + px_acum *(1 - x[[1]][[j]])*m_me*(1.03/1.07)^(j-1)
      } else {
        interes <- 1.07^(1/12) - 1
        # Valor presente de las anualidades y aguinaldo
        VP_ann <- m_p*(1-(1/1.07))/interes
        VP_agui <- m_p*(1/1.07)
        VP <- VP_ann + VP_agui
        vp_pen <- vp_pen + px_acum *(1 - x[[1]][[j]])*m_mp*(1.03/1.07)^(j-1)
        vp_pen <- vp_pen + px_acum *(x[[1]][[j]])*VP*(1.03/1.07)^(j-1)
      }
      # Actualiza la probabilidad acumulada
      px_acum <- px_acum *(x[[1]][[j]])
      
      
    }
    # Cálculo de las anualidades
    annuity <- (1-(1.03/1.07)^(65 - x[[3]]))/(((1.07/1.03)-1)*(1.03/1.07))

    # Almacena los resultados en el dataframe
    df$edad[c] <- x[[3]]
    df$sexo[c] <- x[[2]]
    df$vp[c] <- vp_pen
    df$anualidad[c] <- annuity
    df$prima[c] <- vp_pen/annuity
    c <- c+1
  }
  return(df)
}
```

```{r}
(sum(primas_esp(qx, 300000, 5000000, 1000000)$vp))
metodo0 <- primas_esp(qx, 300000, 5000000, 1000000)$prima
```

## Método 1
Para la reducción de las primas, tendremos que comparar entre métodos. Por ejemplo, propongamos en reducir la pensión lo necesario, usando aproximación manual
```{r}
metodo1 <- primas_esp(qx, 269181, 5000000, 1000000)$prima
sum(metodo1/metodo0 <=0.9)/length(metodo0) # si da 1, todos coinciden
mean(metodo1/metodo0) # esta cantidad es para resumir, se cumple lo de arriba
```

## Método 2
Ahora bien, reduzca aún más el monto de la pensión, pero duplique los otros montos
```{r}
metodo2 <- primas_esp(qx, 261000, 10000000, 2000000)$prima # dio cerrado
sum(metodo2/metodo0 <=0.9)/length(metodo0) 
mean(metodo2/metodo0)
```

## Métodos alternativos
Observe que la diferencia es muy poca, las mortalidades de empleados y pensionados aportan muy poco. Reducir estas a 0 no influye mucho
```{r}
mean(primas_esp(qx, 300000, 0, 0)$prima/metodo0)
```

Entonces una opción sería aumentar más o igualar los montos de muerte
```{r}
metodo3 <- primas_esp(qx, 250104, 7500000, 7500000)$prima
sum(metodo3/metodo0 <=0.9)/length(metodo0) 
mean(metodo3/metodo0)
```

Note que esta media da un poquito más alto, entonces es un poco peor para la empresa. Calculemos un monto que baje más bien la media, pero todos se reduzcan en un 10%
```{r}
metodo4 <- primas_esp(qx, 207552, 30000000, 15000000)$prima
sum(metodo4/metodo0 <=0.9)/length(metodo0)
mean(metodo4/metodo0)
```

```{r}
rm(metodo0)
rm(metodo1)
rm(metodo2)
rm(metodo3)
rm(metodo4)
rm(primas_esp)
rm(suma_check)
rm(suma_vp)
rm(prima_nivelada)
rm(primas)
```

# Modelo estocástico

Para la construcción de un modelo estocástico ocuparemos:

1) las probabilidades de muerte (qx)
2) las personas, dadas por runif
3) Pagar los montos respectivos, dependiendo de la muerte o no

```{r}
lista_90 <- data.frame(Edad = primas_anuales$edad, Sexo = primas_anuales$sexo)
qx_unicos <- get_qx(lista_90, SUPEN_num)
anualidades <- primas_anuales$anualidad
edades <- numeric(90)
sexo <- numeric(90)
for (c in 1:90){
  edades[c] <- qx_unicos[[c]][[3]]
  sexo[c] <- qx_unicos[[c]][[2]]
}
VP <- (300000*(1-(1/1.07)))/(1.07^(1/12) - 1) + 300000*(1/1.07) # modificación - aguinaldo a final de año)
```

## Creando la función de simulación
```{r}
#' Realiza una simulación del valor presente de las pensiones de forma estocástica
#'
#' @param df Recibe un dataframe que contiene la probabilidad de supervivencia, edad y sexo para cada individuo
#' @return Devuelve un dataframe con las primas calculadas para cada individuo
simulacion <- function(df){
  # Inicializa los vectores para contar los vivos, las pensiones y la suma del valor   presente
  vivos <- numeric(length(df)) + 1
  pen <- numeric(length(df))
  suma_vp <- numeric(length(df))
  # Itera sobre cada uno de los períodos
  for (i in 1:96){
    # Calcula el factor de descuento para el período actual
    dif <- (1.03/1.07)^(i-1)
    # Itera sobre cada individuo en el dataframe
    for (c in 1:length(df)){
      # Si el individuo ya está muerto o no hay más datos de probabilidad, pasa al        siguiente
      if(vivos[c] == 0 | i > length(df[[c]][[1]])){
        next
      }
      
      # Si la edad del individuo más el período actual es mayor a 65, se le otorga         pensión
      if(df[[c]][[3]] + i > 65){
        pen[c] <- 1
      }
      
      # Si el individuo está vivo, realiza una simulación de muerte
      if(vivos[c] == 1){
        if(runif(1) > df[[c]][[1]][[i]]){
          vivos[c] <- 0
          # Calcula el valor presente en caso de muerte, dependiendo de si tenía               pensión o no
          if(pen[c] == 1){
            suma_vp[c] <- suma_vp[c] + 1000000*dif
          } else {
            suma_vp[c] <- suma_vp[c] + 5000000*dif
          }
        }
      }
      # Suma el valor presente de las pensiones en caso de que el individuo siga vivo
      suma_vp[c] <- suma_vp[c] + pen[c]*vivos[c]*VP*dif
    }
  }

  # Calcula las primas dividiendo la suma del valor presente por las anualidades
  df <- data.frame(prima = suma_vp/anualidades)

  return(df[[1]])
}
```

```{r}
t <- proc.time()
una <- simulacion(qx_unicos)
proc.time() - t
```

## Las simulaciones
La función dura 30 min, o 26 min aproximadamente
```{r}
# t <- proc.time()
# simulaciones <- list()
# for(i in 1:100000){
#   print(i)
#   simulaciones[[i]] <- simulacion(qx_unicos)
# }
# proc.time() - t
```

## Proceder a escribir la data para guardarla
```{r}
# datos_sim <- data.frame(primas_anuales[,1:2], simulaciones)
# names(datos_sim) <- c("edad", "sexo", 1:100000)
# write.csv(datos_sim,"simulaciones.csv")
```

## Revertir el cambio e importar los datos
```{r}
datos_sim <- read_csv("data/simulaciones.csv", show_col_types = FALSE) %>% select(-`...1`)
```

## Cálculo de percentiles
```{r}
t <- proc.time()
percentiles <- data.frame(primas_anuales[,1:2])
for (i in 1:90){
  temp <- as.numeric(datos_sim[i,3:100002])
  percentiles$per_50[i] <- quantile(temp, 0.5)
  percentiles$per_90[i] <- quantile(temp, 0.9)
}
proc.time() - t
```

```{r}
rm(una)
rm(i)
rm(get_qx)
rm(simulacion)
rm(VP)
rm(t)
rm(sexo)
rm(edades)
rm(anualidades)
rm(lista_90)
rm(temp)
```

# Comparación de primas
```{r}
primas_finales <- primas_anuales[,1:3]
primas_finales$per_50 <- percentiles$per_50
primas_finales$per_90 <- percentiles$per_90
```

```{r, warning=FALSE}
ggplot() +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
            aes(x = edad, y = prima/1000000, color = "determinístico"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
            aes(x = edad, y = per_50/1000000, color = "estocástico - per50"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
          aes(x = edad, y = per_90/1000000, color = "estocástico - per90"),
          size = 1) +
  scale_color_manual(
    values = c(
      "determinístico" = "lightblue",
      "estocástico - per50" = "royalblue",
      "estocástico - per90" = "darkblue"
    )
  ) +
  labs(
    x = "Edad",
    y = "Monto",
    title = "Primas para hombres de edades 20-50",
    color = "Tipo de prima"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(20,50) +
  ylim(0,5)
```

```{r, warning=FALSE}
ggplot() +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
            aes(x = edad, y = prima/1000000, color = "determinístico"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
            aes(x = edad, y = per_50/1000000, color = "estocástico - per50"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
          aes(x = edad, y = per_90/1000000, color = "estocástico - per90"),
          size = 1) +
  scale_color_manual(
    values = c(
      "determinístico" = "lightblue",
      "estocástico - per50" = "royalblue",
      "estocástico - per90" = "darkblue"
    )
  ) +
  labs(
    x = "Edad",
    y = "Monto",
    title = "Primas para hombres de edades 50-65, en millones",
    color = "Tipo de prima"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(50,65) +
  ylim(2,80)
```
```{r, warning=FALSE}
ggplot() +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
            aes(x = edad, y = per_90 - prima, color = "estocástico - per90"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 1,],
            aes(x = edad, y = per_50 - prima, color = "estocástico - per50"),
            size = 1) +
  scale_color_manual(
    values = c(
      "estocástico - per90" = "darkorange",
      "estocástico - per50" = "orange"
    )
  ) +
  labs(
    x = "Edad",
    y = "Monto",
    title = "Diferencias en las primas, para hombres entre 20 y 60 años",
    color = "Tipo de prima"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(20,65) +
  ylim(0,5000000)
```

```{r, warning=FALSE}
ggplot() +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
            aes(x = edad, y = prima/1000000, color = "determinístico"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
            aes(x = edad, y = per_50/1000000, color = "estocástico - per50"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
          aes(x = edad, y = per_90/1000000, color = "estocástico - per90"),
          size = 1) +
  scale_color_manual(
    values = c(
      "determinístico" = "lightpink",
      "estocástico - per50" = "purple",
      "estocástico - per90" = "red"
    )
  ) +
  labs(
    x = "Edad",
    y = "Monto",
    title = "Primas para mujeres de edades 20-50, en millones",
    color = "Tipo de prima"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(20,50) +
  ylim(0,5)
```

```{r, warning=FALSE}
ggplot() +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
            aes(x = edad, y = prima/1000000, color = "determinístico"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
            aes(x = edad, y = per_50/1000000, color = "estocástico - per50"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
          aes(x = edad, y = per_90/1000000, color = "estocástico - per90"),
          size = 1) +
  scale_color_manual(
    values = c(
      "determinístico" = "lightpink",
      "estocástico - per50" = "purple",
      "estocástico - per90" = "red"
    )
  ) +
  labs(
    x = "Edad",
    y = "Monto",
    title = "Primas para mujeres de edades 50-65, en millones",
    color = "Tipo de prima"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(50,65) +
  ylim(2,80)
```

```{r, warning=FALSE}
ggplot() +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
            aes(x = edad, y = per_90 - prima, color = "estocástico - per90"),
            size = 1) +
  geom_line(data = primas_finales[primas_finales$sexo == 2,],
            aes(x = edad, y = per_50 - prima, color = "estocástico - per50"),
            size = 1) +
  scale_color_manual(
    values = c(
      "estocástico - per90" = "slateblue2",
      "estocástico - per50" = "mediumpurple1"
    )
  ) +
  labs(
    x = "Edad",
    y = "Monto",
    title = "Diferencias en las primas, para mujeres entre 20 y 60 años",
    color = "Tipo de prima"
  ) +
  theme_minimal() +
  theme(legend.position = 'bottom') +
  xlim(20,65) +
  ylim(0,5000000)
```

No lograría explicar el comportamiento quebrado en la simulación. Por lo que no hay que incluir estos gráficos.



