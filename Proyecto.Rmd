---
title: "Proyecto"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Fabián Brenes Thomas - C21380
  - Marco Antonio Guardia Ortiz - C23521
  - Anthony Mauricio Jiménez Navarro - C24067
  - Laura Jimena Villacís Delgado - C28386
date: "2024-05-13"
output: 
  rmdformats::downcute:
    default_style: "dark"
    downcute_theme: "chaos"
---

# Importar y descargar los datos
```{r, warning=FALSE}
library(readxl)
library(tidyverse)
ABC <- read_excel("Base de datos.xlsx")
SUPEN <- read_excel("tavid2000-2150.xls")
SUPEN_num <- as.data.frame(lapply(SUPEN, as.numeric), stringsAsFactors = FALSE)
```
## Transformaciones menores
```{r}
ABC$Edad = 2023 - as.double(format(ABC$`Fecha de nacimiento`, format="%Y"))
ABC[ABC$Sexo == 'M',]$Sexo <- '1'
ABC[ABC$Sexo == 'F',]$Sexo <- '2'
ABC$Sexo <- as.double(ABC$Sexo) 
```

# Función para recolectar los qx de un df agrupado
```{r}
get_qx <- function(df_obs, df_prob){
  c <- 1
  all_qx = list()
  for (i in 1:length(df_obs[[1]])){
    x <- df_obs$Edad[i]
    if(i != 1) {
      if((df_obs$Edad[i-1] == x) & (df_obs$Sexo[i] == df_obs$Sexo[i-1])){
        
        all_qx[c] <- all_qx[c-1]
        c <- c+1
        next
      }
    } 
    y <- 2023
    df <- df_prob[df_prob$sex == df_obs$Sexo[i],]
    local_qx <- list()
    n <- 1
    while (any(df$edad == x & df$year == y)) {
      # Filtrar datos por edad y año actual 
      qx <- df[df$edad == x & df$year == y , ]$qx
      local_qx[n] <- 1 - qx
      n <- n + 1
      x <- x + 1
      y <- y + 1
    }
    all_qx[[c]] <- list()
    all_qx[[c]][[1]] <- local_qx
    all_qx[[c]][[2]] <- df_obs$Sexo[i] 
    all_qx[[c]][[3]] <- df_obs$Edad[i] 
    c <- c+1
  }
  return(all_qx)
}
```

## Recolectar la probabilidad de muerte/sobrevivencia de cada observación
```{r}
t <- proc.time()
qx <- get_qx(ABC, SUPEN_num)
proc.time() - t
```
# Proyecciones demográficas

## Función madre: observar las posibilidades de vivir
```{r}
proy_per_viva <- data.frame(edad = 0:100, poblacionM = numeric(101), poblacionH = numeric(101))
proy_per_viva$poblacionH[1] = 272
proy_per_viva$poblacionM[1] = 228

proy_viva <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  for (i in 1:100){
    m <- 0
    h <- 0
    for (c in 1:500){
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        if(i > length(qx[[c]][[1]])){
          next
        }        
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
      } else {
        m <- m +1
        if(i > length(qx[[c]][[1]])){
          next
        }         
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
      }
    }
    df$poblacionH[i+1] <- sum(acumH)
    df$poblacionM[i+1] <- sum(acumM)
  }
  return(df)
}

proy_per_viva <- proy_viva(qx, proy_per_viva)
proy_per_viva$poblacionM <- round(proy_per_viva$poblacionM, 8)
proy_per_viva$poblacionH <- round(proy_per_viva$poblacionH, 8)
```

## Caso contrario
```{r}
proy_per_muerta <- proy_per_viva
proy_per_muerta$poblacionM <- 228 - proy_per_muerta$poblacionM
proy_per_muerta$poblacionH <- 272 - proy_per_muerta$poblacionH
```

## Seccionar a solo empleados vivos
```{r}
proy_emp_viva <- data.frame(edad = 0:100, poblacionM = numeric(101), poblacionH = numeric(101))
proy_emp_viva$poblacionH[1] = 272
proy_emp_viva$poblacionM[1] = 228

proy_emp_vivos <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  for (i in 1:100){
    m <- 0
    h <- 0
    for (c in 1:500){
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        if(i > length(qx[[c]][[1]])){
          next
        }
        if(65 <= qx[[c]][[3]] + i){
          acumH[h] <- 0
          next
        }        
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
      } else {
        m <- m +1
        if(i > length(qx[[c]][[1]])){
          next
        }     
        if(65 <= qx[[c]][[3]] + i){
          acumM[m] <- 0
          next
        } 
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
      }
    }
    df$poblacionH[i+1] <- sum(acumH)
    df$poblacionM[i+1] <- sum(acumM)
  }
  return(df)
}

proy_emp_viva <- proy_emp_vivos(qx, proy_emp_viva)
proy_emp_viva$poblacionM <- round(proy_emp_viva$poblacionM, 8)
proy_emp_viva$poblacionH <- round(proy_emp_viva$poblacionH, 8)
```

## Seccionar a solo pensionados muertos
```{r}
proy_pen_viva <- data.frame(edad = 0:100, poblacionM = numeric(101), poblacionH = numeric(101))
proy_pen_vivos <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  for (i in 1:100){
    m <- 0
    h <- 0
    penH <- numeric(272)
    penM <- numeric(228)
    for (c in 1:500){
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        if(i > length(qx[[c]][[1]])){
          next
        }
        if(65 <= qx[[c]][[3]] + i){
          penH[h] <- 1
        }        
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
        penH[h] <- penH[h] * acumH[h]
      } else {
        m <- m +1
        if(i > length(qx[[c]][[1]])){
          next
        }     
        if(65 <= qx[[c]][[3]] + i){
          penM[m] <- 1
        } 
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
        penM[m] <- penM[m]*acumM[m]
      }
    }
    df$poblacionH[i+1] <- sum(penH)
    df$poblacionM[i+1] <- sum(penM)
  }
  return(df)
}
proy_pen_viva <- proy_pen_vivos(qx, proy_pen_viva)
proy_pen_viva$poblacionM <- round(proy_pen_viva$poblacionM, 8)
proy_pen_viva$poblacionH <- round(proy_pen_viva$poblacionH, 8)
```

## Seccionar a solo empleados muertos
```{r}
proy_emp_muerta <- data.frame(edad = 0:100, poblacionM = numeric(101), poblacionH = numeric(101))

proy_emp_dead <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  for (i in 1:100){
    m <- 0
    h <- 0
    localH <- numeric(272)
    localM <- numeric(228)
    for (c in 1:500){
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        if(i > length(qx[[c]][[1]])){
          next
        }
        if(65 <= qx[[c]][[3]] + i){
          acumH[h] <- 0
          next
        }        
        localH[h] <- acumH[h]*(1 - qx[[c]][[1]][[i]])
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
      } else {
        m <- m +1
        if(i > length(qx[[c]][[1]])){
          next
        }     
        if(65 <= qx[[c]][[3]] + i){
          acumM[m] <- 0
          next
        } 
        localM[m] <- acumM[m]*(1 - qx[[c]][[1]][[i]])
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
      }
    }
    df$poblacionH[i+1] <- sum(localH) + df$poblacionH[i]
    df$poblacionM[i+1] <- sum(localM) + df$poblacionM[i]
  }
  return(df)
}

proy_emp_muerta <- proy_emp_dead(qx, proy_emp_muerta)
proy_emp_muerta$poblacionM <- round(proy_emp_muerta$poblacionM, 8)
proy_emp_muerta$poblacionH <- round(proy_emp_muerta$poblacionH, 8)
```

## Seccionar a solo pensionados muertos
```{r}
proy_pen_muerta <- data.frame(edad = 0:100, poblacionM = numeric(101), poblacionH = numeric(101))
proy_pen_dead <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1
  for (i in 1:100){
    m <- 0
    h <- 0
    penH <- numeric(272)
    penM <- numeric(228)
    for (c in 1:500){
      if(qx[[c]][[2]] == 1){
        h <- h + 1
        if(i > length(qx[[c]][[1]])){
          next
        }
        if(65 <= qx[[c]][[3]] + i){
          penH[h] <- 1
        }        
        penH[h] <- penH[h] * acumH[h] *(1 - qx[[c]][[1]][[i]])
        acumH[h] <- acumH[h]*qx[[c]][[1]][[i]]
      } else {
        m <- m +1
        if(i > length(qx[[c]][[1]])){
          next
        }     
        if(65 <= qx[[c]][[3]] + i){
          penM[m] <- 1
        } 
        penM[m] <- penM[m]*acumM[m]*(1-qx[[c]][[1]][[i]])
        acumM[m] <- acumM[m]*qx[[c]][[1]][[i]]
      }
    }
    df$poblacionH[i+1] <- sum(penH) + df$poblacionH[i]
    df$poblacionM[i+1] <- sum(penM) + df$poblacionM[i]
  }
  return(df)
}
proy_pen_muerta <- proy_pen_dead(qx, proy_pen_muerta)
proy_pen_muerta$poblacionM <- round(proy_pen_muerta$poblacionM, 8)
proy_pen_muerta$poblacionH <- round(proy_pen_muerta$poblacionH, 8)
```

# Resumir los resultados demográficos

## En la proyección de mujeres
```{r}
proy_mujeres <- data.frame(
  edad = 0:100,
  proy_vivas = proy_per_viva$poblacionM,
  proy_muertas = proy_per_muerta$poblacionM,
  proy_emp_vivas = proy_emp_viva$poblacionM,
  proy_pen_vivas = proy_pen_viva$poblacionM,
  proy_emp_muertas = proy_emp_muerta$poblacionM,
  proy_pen_muertas = proy_pen_muerta$poblacionM
)
```

## En la proyección de hombres
```{r}
proy_hombres <- data.frame(
  edad = 0:100,
  proy_vivos = proy_per_viva$poblacionH,
  proy_muertos = proy_per_muerta$poblacionH,
  proy_emp_vivos = proy_emp_viva$poblacionH,
  proy_pen_vivos = proy_pen_viva$poblacionH,
  proy_emp_muertos = proy_emp_muerta$poblacionH,
  proy_pen_muertos = proy_pen_muerta$poblacionH
)
```

## Verificar los resultados
```{r}
proy_hombres$suma = proy_hombres$proy_emp_vivos + 
  proy_hombres$proy_pen_vivos + 
  proy_hombres$proy_emp_muertos +
  proy_hombres$proy_pen_muertos

proy_mujeres$suma = proy_mujeres$proy_emp_vivas + 
  proy_mujeres$proy_pen_vivas + 
  proy_mujeres$proy_emp_muertas +
  proy_mujeres$proy_pen_muertas

```












