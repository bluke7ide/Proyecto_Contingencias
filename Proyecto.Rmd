---
title: "Proyecto"
author: 
  - Luis Fernando Amey Apuy - C20470
  - Fabián Brenes Thomas - C21380
  - Marco Antonio Guardia Ortiz - C23521
  - Anthony Mauricio Jiménez Navarro - C24067
  - Laura Jimena Villacís Delgado - C28386
date: "2024-05-13"
output: 
  rmdformats::downcute:
    default_style: "dark"
    downcute_theme: "chaos"
---


```{r}
library(readxl)
library(tidyverse)
ABC <- read_excel("Base de datos.xlsx")
SUPEN <- read_excel("tavid2000-2150.xls")
SUPEN_num <- as.data.frame(lapply(SUPEN, as.numeric), stringsAsFactors = FALSE)
ABC$Edad = 2023 - as.double(format(ABC$`Fecha de nacimiento`, format="%Y"))
```



```{r}

ABC[ABC$Sexo == 'M',]$Sexo <- '1'
ABC[ABC$Sexo == 'F',]$Sexo <- '2'
ABC$Sexo <- as.double(ABC$Sexo) 



# hacer un check de las qx por cada año por cada persona. Sumarlas todas. Ya entendí la dificultad de este ejercicio


```

```{r}
get_qx <- function(df_obs, df_prob){
  c <- 1
  all_qx = list()
  for (i in 1:length(df_obs[[1]])){
    x <- df_obs$Edad[i]
    if(i != 1) {
      if((df_obs$Edad[i-1] == x) & (df_obs$Sexo[i] == df_obs$Sexo[i-1])){
        
        all_qx[c] <- all_qx[c-1]
        c <- c+1
        next
      }
    } 
    y <- 2023
    df <- df_prob[df_prob$sex == df_obs$Sexo[i],]
    local_qx <- list()
    n <- 1
    while (any(df$edad == x & df$year == y)) {
      # Filtrar datos por edad y año actual 
      qx <- df[df$edad == x & df$year == y , ]$qx
      local_qx[n] <- 1 - qx
      n <- n + 1
      x <- x + 1
      y <- y + 1
    }
    all_qx[[c]] <- list()
    all_qx[[c]][[1]] <- df_obs$Sexo[i] 
    all_qx[[c]][[2]] <- local_qx
    c <- c+1
  }
  
  return(all_qx)
}
```


```{r}
t <- proc.time()
qx <- get_qx(ABC, SUPEN_num)
proc.time() - t
```

```{r}
proy_per_viva <- data.frame(edad = 0:100, poblacion = numeric(101))
proy_per_viva$poblacionH[1] = 272
proy_per_viva$poblacionM[1] = 228

proy_viva <- function(qx, df){
  acumH <- numeric(272) + 1
  acumM <- numeric(228) + 1

  for (i in 1:100){
    m <- 0
    h <- 0
    for (c in 1:500){
      if(qx[[c]][[1]] == 1){
        h <- h +1
        if(i > length(qx[[c]][[2]])){
          next
        }        
        acumH[h] <- acumH[h]*qx[[c]][[2]][[i]]
      } else {
        m <- m +1
        if(i > length(qx[[c]][[2]])){
          next
        }         
        acumM[m] <- acumM[m]*qx[[c]][[2]][[i]]
      }
    }

    df$poblacionH[i+1] <- sum(acumH)
    df$poblacionM[i+1] <- sum(acumM)

  }
  return(df)
}

proy_per_viva <- proy_viva(qx, proy_per_viva)
proy_per_viva$poblacionM <- floor(proy_per_viva$poblacionM)
proy_per_viva$poblacionH <- floor(proy_per_viva$poblacionH)
```

```{r}
proy_emp 
```




















